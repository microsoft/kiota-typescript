
name: Build and test all the Kiota packages
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: ['packages/abstractions/**', '.github/workflows/**']
  pull_request:
    paths: ['packages/abstractions/**', '.github/workflows/**']

jobs:
    build:
        runs-on: ubuntu-latest
        environment:
          name: build_test
        strategy:
          matrix:
            node-version: [14.x, 16.x]
        steps:
        - uses: actions/checkout@v3
        - name: Use Node.js ${{ matrix.node-version }}
          uses: actions/setup-node@v3
          with:
            node-version: ${{ matrix.node-version }}
        - run: yarn install --frozen-lockfile
        - run: yarn run build
        - run: lerna run test --parallel
        - run: lerna run test:integrated
          working-directory: packages/abstractions
          env:
            TENANT_ID:  ${{secrets.tenant_id}}
            CLIENT_ID: ${{secrets.client_id}}
            CLIENT_SECRET: ${{secrets.client_secret}}
